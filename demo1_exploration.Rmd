---
title: "Hartford Crime and Property Value Data Exploration"
author: "Quan Le, David Lieberman, Lisa Lin"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(ggplot2)
library(plotly)
library(sf)
library(tigris)
library(tidycensus)
library(magrittr)
library(data.table)
library(ks)

here::i_am(".git/config")
knitr::opts_chunk$set("root.dir" = here::here("HW3"))
# knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(message = FALSE)

setDTthreads(threads = 0)

options(tigris_use_cache = TRUE)
options(tigris_year = 2021)

census_api_key("695c23fb2b498d7f1b1b96cac681c456fea16cfd")
```

## Data Cleaning

The filters applied to the parcel and crime data are:

* Single family homes only
* Crimes from 2016-2021 since the assessed property values are from 2021, and we deem crimes prior to 2016 to be less relevant to the current property values

```{r cleaning, eval = FALSE}
# Get crime data from ArcGIS API and remove (4) entries with missing geometry.
# Write cleaned data to GeoJSON
# crime_dg <- st_read("https://utility.arcgis.com/usrsvcs/servers/0eaa6be357a74f5280157125e9b547fc/rest/services/OpenData_PublicSafety/FeatureServer/2/query?outFields=*&where=1%3D1&f=geojson")
# crime_dg$Date <- as.Date(fread(".//data//crime_dg.csv")$Date, "%Y/%m/%d")
# crime_dg <- crime_dg[!st_is_empty(crime_dg),]
# st_write(crime_dg, ".//data//crime_dg.geojson")

# # Read in the Hartford crime and parcel data
# crime_dg <- st_read(".//data//crime_dg.geojson")
# parcel_dg <- st_read(".//data//parcel_hartford.geojson")

# # Filter crime data to 2016-2021 and parcel data to single family homes
# crime_dg <- crime_dg |> 
#   subset(year(Date) %in% 2016:2021) |> 
#   st_transform(st_crs(hartford_tracts))
# parcel_dg <- parcel_dg |> 
#   subset(State_Use_Description == "ONE FAMILY") |> 
#   st_transform(st_crs(hartford_tracts))
```

## Data Exploration

```{r tracts}
# Get the census tracts from Tigris for the map baselayer
hartford_census_data <- get_acs(
  geography = "tract", variable = c("B19013_001", "B01001_001"), 
  state = "CT", county = "Hartford", year = 2021
  ) |>
   dplyr::select(GEOID, variable, estimate) |>
   tidyr::pivot_wider(names_from = variable, values_from = estimate) |>
   dplyr::rename(population = "B01001_001", med_income = "B19013_001")

hartford_tracts <- st_filter(tracts(state = "CT"),
                             subset(county_subdivisions(state = "CT"), 
                                    NAMELSAD == "Hartford town"),
                             .predicate = st_within)
hartford_tracts <- merge(hartford_tracts, hartford_census_data, by = "GEOID")

water <- st_intersection(area_water("CT", "Hartford"), hartford_tracts)
```

#### Total Crime Count Heatmap

```{r, warning = FALSE}
# Read in the Hartford crime and parcel data
crime_dg <- st_read(".//data//crime_hartford_2016_2021.geojson")
parcel_dg <- st_read(".//data//parcel_hartford_single_family_crimestats.geojson")

# Plot
ggplot(crime_dg) +
   geom_sf(data = hartford_tracts) +
   geom_sf(data = water, color = "blue", linewidth = 0.35) +
   geom_hex(aes(X, Y, fill = log10(..count..)), 
            data = ~cbind(.x, st_coordinates(.x)), alpha = 0.75, bins = 50) +
   scale_fill_binned() +
   scale_x_continuous(guide = guide_axis(angle = 45)) +
   labs(x = "Latitude", y = "Longitude") +
   theme_bw()
```

#### Interactive Crime and Property Value Heatmap

Crime is in red, parcels are in black, and the density of crime is in blue. Additional census tract level information like median income and population are included in the tooltip. Interact with the map for details.

```{r, warning = FALSE}
g <- ggplot(dplyr::sample_n(crime_dg, 1e3)) +
   geom_sf(data = hartford_tracts, aes(label1 = GEOID,
                                       label2 = med_income,
                                       label3 = population)) +
   geom_sf(data = dplyr::sample_n(parcel_dg, 1e3)) +
   geom_density_2d(aes(X,Y), data = ~cbind(.x, st_coordinates(.x))) +
   stat_sf_coordinates(size = 0.1, color = "red") +
   labs(x = "Latitude", y = "Longitude") +
   theme_bw() +
   theme(axis.text.x = element_text(angle = 45))

p <- toWebGL(ggplotly(g))
p$x$data[[4]]$hoverinfo <- "none"
p
```

The manually curated variables are:

* `Price`: Assessed total value of the parcel
* `Thefts`: Number of thefts (robberies, burglaries, larceny, theft, or stolen property) within 150 meters of the parcel
* `Violence`: Number of violent crimes (assaults, homicides, shootings) within 150 meters of the parcel
* `Living_Area`: Living area of the parcel
* `Effective_Area`: Effective area of the parcel
* `Year`: Approximate year the parcel was built
* `Bed`: Number of bedrooms in the parcel
* `Bath`: Number of bathrooms in the parcel

The highly correlated numeric covariates are 

* Thefts and Violence
* Living Area and Effective Area
* Bed and Bath

There appear to be more thefts and violent crimes near single family homes in `dilapidated` condition. Homes in worse condition tend to be older, but there are also older homes in good condition.

There is not a clear relationship between the year the parcel was built and its condition. 

All covariates appear to correlate with the response variable, `Assessed_Total`.

```{r}
# Load prepared data with kernel density estimates for thefts and violence
# See demo2 for details

parcel_dg %<>% 
  subset(select = c(
    "Assessed_Total", "Living_Area", "Effective_Area", "AYB",
    "Number_of_Bedroom", "Number_of_Baths", "Condition_Description"))

parcel_dg %<>% 
  dplyr::rename(
    Price = "Assessed_Total", Year = "AYB", Bed = "Number_of_Bedroom",
    Bath = "Number_of_Baths", Condition = "Condition_Description")

parcel_dg$Condition %<>% 
  factor(levels = c("Dilapidated", "Very Poor", "Poor", "Fair", "Fair-Avg", 
                    "Average", "Avg-Good", "Good", "Good-VG", "Very Good", 
                    "Excellent"))

paste0("Dropping n=", nrow(parcel_dg) - nrow(na.omit(parcel_dg)), 
       " rows with NAs.")
X <- na.omit(parcel_dg)
```

```{r}
stealing <- crime_dg[grep("ROBBERY|BURGLARY|LARCENY|THEFT", 
                          crime_dg$UCR_1_Category), ]
violence <- crime_dg[grep("ASSAULT|HOMICIDE|SHOOTING", 
                          crime_dg$UCR_1_Category), ]

sf_use_s2(FALSE)
X$Thefts <- st_is_within_distance(st_transform(X, crs = 26956),
                                  st_transform(stealing, crs = 26956),
                                  dist = units::set_units(150, "m")) |> 
  sapply(length)

X$Violence <- st_is_within_distance(st_transform(X, crs = 26956),
                                    st_transform(violence, crs = 26956),
                                    dist = units::set_units(150, "m")) |> 
  sapply(length)
```

```{r}
X$GEOID <- hartford_tracts$GEOID[st_intersects(X, hartford_tracts) |> 
                                   sapply(head, 1)]

setDT(copy(X))[as.data.table(hartford_tracts),
               .(violence_rate = sum(Violence)/i.population,
                 avg_property_value = mean(Price)),
               on = "GEOID", by = .EACHI]
```

